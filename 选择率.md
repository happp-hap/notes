
[返回 - pg 索引扫描的代价估计](./pg索引扫描的代价估计.md)

# 选择率

## 选择率是什么？

选择率，0~1 的浮点数，代表查询指定的 where 子句在索引中搜索范围的比例。

## 高频值 和 直方图界值

1. 使用 高频值 来作为选择率

了解高频值，我们来看一个例子。

有一个数据表，存储了国家和对应的大洲。
[对应 sql ](./create_table_countires.sql)

```
testdb=# \d countries 
             Table "public.countries"
  Column   | Type | Collation | Nullable | Default 
-----------+------+-----------+----------+---------
 country   | text |           |          | 
 continent | text |           |          | 
Indexes:
    "continent_idx" btree (continent)
```

可以看到对应大洲国家的比例：

```
testdb=# SELECT continent, count(*) AS "number of countries",
    (count(*)/(SELECT count(*) from countries)::real) AS "number of countries / all countries"
    from countries GROUP BY continent ORDER BY "number of countries" DESC;

   continent   | number of countries | number of countries / all countries 
---------------+---------------------+-------------------------------------
 Africa        |                  54 |                 0.27835051546391754
 Europe        |                  47 |                  0.2422680412371134
 Asia          |                  44 |                  0.2268041237113402
 North America |                  23 |                 0.11855670103092783
 Oceania       |                  14 |                 0.07216494845360824
 South America |                  12 |                0.061855670103092786
(6 rows)

```

我们来查询一下亚洲的情况：

```
testdb=# select * from countries where continent = 'Asia';
      country       | continent 
--------------------+-----------
 Afghanistan        | Asia
 Bahrain            | Asia
 Bangladesh         | Asia
 Bhutan             | Asia
 Brunei             | Asia
 Burma(Myanmar)     | Asia
 Cambodia           | Asia
 China              | Asia
 EastTimor          | Asia
 India              | Asia
 Indonesia          | Asia
 Iran               | Asia
 Iraq               | Asia
 Israel             | Asia
 Japan              | Asia
 Jordan             | Asia
 Kazakhstan         | Asia
 Korea,North        | Asia
 Korea,South        | Asia
 Kuwait             | Asia
 Kyrgyzstan         | Asia
 Laos               | Asia
 Lebanon            | Asia
 Malaysia           | Asia
 Maldives           | Asia
 Mongolia           | Asia
 Nepal              | Asia
 Oman               | Asia
 Pakistan           | Asia
 Philippines        | Asia
 Qatar              | Asia
 RussianFederation  | Asia
 SaudiArabia        | Asia
 Singapore          | Asia
 SriLanka           | Asia
 Syria              | Asia
 Tajikistan         | Asia
 Thailand           | Asia
 Turkey             | Asia
 Turkmenistan       | Asia
 UnitedArabEmirates | Asia
 Uzbekistan         | Asia
 Vietnam            | Asia
 Yemen              | Asia
(44 rows)



testdb=# \x
Expanded display is on.
testdb=# select most_common_vals, most_common_freqs FROM pg_stats where tablename = 'countries' and attname='continent';
-[ RECORD 1 ]-----+-------------------------------------------------------------------
most_common_vals  | {Africa,Europe,Asia,"North America",Oceania,"South America"}
most_common_freqs | {0.2783505,0.24226804,0.22680412,0.1185567,0.072164945,0.06185567}


```

其中 `most_common_vals` 给出了 continent 列常用的值，`most_common_freqs` 给出了它们的频率。
比如亚洲 Asia，对应 0.22680412，这个就是高频值，在这里作为选择率。



2. 使用 直方图界值 来作为选择率




[返回 - pg 索引扫描的代价估计](./pg索引扫描的代价估计.md)

