

# pg 查询流程梳理

## pg 是什么？

pg的官方网站是： 
    
    www.postgresql.org

在 pg 的官方网站上，可以看到 pg 的介绍：
    
    PostgreSQL 是一个功能强大的开源对象关系数据库系统，经过 30 多年的积极开发，在可靠性、功能稳健性和性能方面赢得了良好的声誉。

## 为什么要介绍 pg 的查询流程？

因为pg是一个数据库，数据库的主要功能就是存储和查询数据，所以其中的查询流程至关重要，也非常复杂。了解查询流程，是快速接近 pg 核心内容的好办法。

## pg 的查询流程是怎样的？

说到pg的查询流程，首先要知道pg的架构。pg 是 服务器/客户端 架构的。每当用户使用客户端发起一个连接，服务器端负责和客户端联络的守护进程 postmaster 就会启动一个专门的进程和客户端交互，这个进程叫做 postgres。


所以我们说的查询流程，就是客户端发送 SQL 请求到服务端的 postgres，postgres 处理好之后再返回客户端的一个过程。这里我们分析 pg 的查询流程，就是从 postgres 进程接到用户的 SQL 请求开始，到准备返回客户端结束。毕竟这是最关键的后台流程，我们先把注意力放在核心的地方。

## pg 的查询流程具体经过那些模块？

### pg 的查询经过5个模块
前面我们说到，查询流程是pg中最常用也是最复杂的流程之一。查询流程经过5个模块，分别是：解析器、分析器、重写器、计划器和执行器。

### pg 的查询首先经过解析器，变成语法解析树。
这5个模块看着有一些复杂，实际上是有着非常清晰的逻辑的。后台 postgres 进程接到用户的 SQL 请求之后，首先进行语法解析，生成解析树。毕竟语法的翻译是第一步，如果是原本的 SQL，服务器肯定无从下手进行处理嘛。生成解析树，这样才能进行后续的操作，服务器才有可能“看懂”用户的 SQL 请求。


解析树就是 parse tree.

### 然后经过分析器，变成查询树。
接着，数据库就会对解析树进行分析，通过分析生成一棵查询树。为什么是查询树呢？我们已经得到了语法解析树，也就说，我们从语法上明白了 SQL 语句的结构，但是语义上 postgres 进程还是不理解。所以这一步主要是进行语义分析，经过分析器语义分析之后，后台就懂得用户“想要做什么了”，并且这些将会存储在生成的查询树之中。


查询树就是 query tree.

### 又经过重写器，从一棵查询树变成另一棵查询树。
我们经常能听说“数据库查询优化”等说法，不过这个多是针对数据库使用者来说的。SQL在后台执行的时候，会根据一些“规则系统”进行调优重写，后台 postgres 进程现在拥有了一棵查询树，但是这棵查询树是根据 语法解析树 直接生成的，那可能很复杂，或者会比较低效。这种情况对于一个成熟优秀的数据来说，是不能容忍的，所以，postgres 进程要对 查询树 进行重写，重写的目的是使之变得高效(〃'▽'〃)。

### 通过计划器，从查询树生成执行计划。
好的，我们现在拥有一棵不错的查询树了。执行器将会操作这棵查询树，尽自己可能，生成一棵能直接执行的高效的计划树。未来执行这棵高效的计划树的模块，自然是执行器了。


计划器是RDBMS中最复杂的部分。它是完全基于 代价估计 的，不支持基于规则的优化与提示。


Relational Database Management System，从字面上可以理解为关系数据库管理系统

计划树就是 plan tree.

### 剩下的交给执行器执行便好了。
执行器 执行这棵高效的计划树。



## 之后的内容：

### A 查询流程在解析器所做的事

### B 查询流程在分析器所做的事

### C 查询流程在重写器所做的事

### D 查询流程在计划器所做的事
[前往 - pg 查询在计划器所做的事 00182](./pg查询流程在计划器所做的事.md) 

### E 查询流程在执行器所做的事




